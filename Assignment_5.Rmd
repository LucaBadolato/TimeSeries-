---
title: "20236 Time Series Analysis - Assignment 5"
author:
- Simone Arrigoni (1794692)
- Luca Badolato (3086040)
- Simone Valle (3088281)
subtitle: "Bocconi University"
date: April 15, 2020
output: pdf_document
header-includes:
  \usepackage[utf8]{inputenc}
  \usepackage{setspace}
  \usepackage{algpseudocode}
  \usepackage{algorithm}
  \usepackage{bm}
  \usepackage{amsmath}
  \usepackage{amssymb}
  \usepackage{graphicx}
  \usepackage{subfig}
  \usepackage{booktabs, caption}
  \usepackage{array}
  \usepackage{threeparttable}
  \usepackage{listings}
  \usepackage{physics}
  \usepackage{float}
  \floatplacement{figure}{H}
  \usepackage{color} %red, green, blue, yellow, cyan, magenta, black, white
  \definecolor{mygreen}{RGB}{28,172,0} % color values Red, Green, Blue
  \definecolor{mylilas}{RGB}{170,55,241}
  \DeclareMathOperator*{\E}{\mathbb{E}}
  \DeclareMathOperator*{\Ec}{\mathbb{E}_t}
---

```{r, include=FALSE}

# Load useful packages
library(utf8)
library(labeling)
library(rmarkdown)
library(httr)
library(knitr)
library(tseries)
library(tinytex)
library(scales)
library(magrittr)
library(stringr)
library(tidyverse)
library(ggplot2)
library(ggfortify)
library(ggpubr)
library(ggthemes)
library(latex2exp)
library(kableExtra)
library(reshape2)
library(depmixS4)
library(dlm)

# Settings
knitr::opts_chunk$set(message = FALSE, 
                      warning = FALSE,
                      echo    = FALSE,
                      include = TRUE,
                      fig.pos = "H",
                      fig.align = "center",
                      out.width = '60%')
```

In this exercise we consider the \textbf{Nile} data, available in R. This provides the measurements of the annual flow of the river Nile at Ashwan, for the period 1871-1970.

We first plot the data in Figure \ref{fig:Nile_plot}.

The series is clearly non-stationary and presents a break point around 1998 (black vertical line).

```{r, fig.width=6, fig.height=4, fig.cap="\\label{fig:Nile_plot} Annual flow of the Nile at Ashwan "}
# Plot the Series "Nile"
# ts.plot(Nile, gpars = list(xlab="Year", ylab="10^8 m^3"))

years_Nile<-seq(as.Date("1871/01/01"),as.Date("1970/01/01"), "years")

df_nile<-data.frame(years_Nile,Nile)

ggplot(df_nile, aes(x=years_Nile, y=Nile)) +
  geom_line(color = "steelblue") +
  geom_vline(xintercept = as.Date('1899/01/01'), color="black")+
  theme_classic(base_size=9) +
  theme(plot.title=element_text(hjust=0.5)) +
  labs(y="10^8 m^3", x="Year") +
  scale_x_date(date_breaks="20 years",
               date_minor_breaks="10 year",
               limits=as.Date(c('1871_01_01','1970_01_01'),
                              tryFormats=c("%Y_%m_%d"),
                              optional=FALSE),
               labels=date_format("%Y")) +
  scale_y_continuous(breaks = seq(0,1500,300), limits = c(300,1500)) +
  theme(axis.text.x=element_text(hjust=1),
        plot.title=element_text(size=10, face="bold", margin=margin(0,0,10,0)),
        axis.title.x=element_text(family="Times", margin=margin(t=5)),
        axis.title.y=element_text(family="Times", margin=margin(r=5)))
```

\section{Question 1}

Let's consider to model the series with a random walk plus noise (or local level) model, a time-invariant DLM with univariate Gaussian observation and state process, i.e. $\underset{1 \times 1}{Y_t}$ and $\underset{1 \times 1}{\theta_t}$, and with constant system matrices $F=1, G=1$:

\begin{eqnarray*} 
Y_t &= \theta_t + v_t \quad    & v_t \overset{i.i.d.}\sim N(0, 15100)\\
\theta_t &= \theta_{t-1} + w_t \quad   & v_t \overset{i.i.d.}\sim N(0, 1470)
\end{eqnarray*}

where variances of these processes are constant and set at $V=\sigma^2_v=15100$ $W=\sigma^2_w=1470$. The initial distribution as well is assumed to be Gaussian with parameters $m_0=1000$ and $C_0=1000$.

Our goal is to compute the filtering states esimates $m_t = \E (\theta_t | y_{1:t})$ obtained by implementing the Kalman filter. Particularly, we recall that the Kalman filter procedure, given the \textit{filtering distribution} in the previous iteration, $\theta_{t-1} \mid \sim N(m_{t-1},C_{t-1})$, is divided in the following three steps:
\begin{itemize}
\item State forecasting step: 
$$ \theta_t \mid y_{1:t-1} \sim N(a_t, R_t), \quad \mbox{state prediction}$$
\item Observation forecasting step:
$$ Y_t \mid y_{1:t-1} \sim N(f_t, Q_t), \quad \mbox{observation prediction}$$

\item Filtering step: once $y_t$ becomes available
$$ \theta_t \mid y_{1:t} \sim N(m_t, C_t), \quad \mbox{filtering distribution}. 
 $$
\end{itemize}
 
```{r}
# Polinomial specification of the RW + noise
rw_Nile <- dlmModPoly(order=1,dV=15100, dW=1470, m0=1000, C0=1000)

# Kalman filter
filt_Nile <- dlmFilter(Nile,rw_Nile)

# Remove the first item (m_0) in the vector of filtered states
filt_est=dropFirst(filt_Nile$m)

#compute the vector of state variances from the Singular Variance Decomposition matrices
list_c <- dlmSvd2var(filt_Nile$U.C, filt_Nile$D.C)

# Compute standard deviations
vol_C <- sqrt(unlist(list_c))

```

We report in Figure \ref{fig:filtering states estimates} the filtering estimates $(m_1, \ldots, m_T)$ (red line) together with the observed series (blue line).Notice that the initial guess on the location parameter of the state distribution, $m_0$, is to be removed from the series of states estimates and, therefore, it is not included in the plot. 

```{r, fig.width=6, fig.height=4, fig.cap="\\label{fig:filtering states estimates} Filtering states estimates"}

df_nile_filt <-data.frame(years_Nile, Nile, filt_est)
   
ggplot(df_nile_filt, aes(x=years_Nile)) +
  geom_line(aes(y=Nile), color = "steelblue") +
  geom_line(aes(y=filt_est), color = "red")+
  geom_vline(xintercept = as.Date('1899/01/01'), color= "black")+
  theme_classic(base_size=9) +
  theme(plot.title=element_text(hjust=0.5)) +
  labs(y="10^8 m^3", x="Year") +
  scale_x_date(date_breaks="20 years",
               date_minor_breaks="10 year",
               limits=as.Date(c('1871_01_01','1970_01_01'),
                              tryFormats=c("%Y_%m_%d"),
                              optional=FALSE),
               labels=date_format("%Y")) +
  scale_y_continuous(breaks = seq(0,1500,300), limits = c(300,1500)) +
  theme(axis.text.x=element_text(hjust=1),
        plot.title=element_text(size=10, face="bold", margin=margin(0,0,10,0)),
        axis.title.x=element_text(family="Times", margin=margin(t=5)),
        axis.title.y=element_text(family="Times", margin=margin(r=5)))
```

We now compute the filtering variances $(C_1, \ldots, C_T)$, that in principle could be determined through the recursive formulas of Kalman filter. However, due to potential numerical issues in the application of such recursive approach, the computation of state variances relies on the Singular Value Decomposition procedure. In Figure \ref{Fig:standard deviations} we report the standard deviations $\sqrt{C_{t}} = V(\theta_t | y_{1:t-1})^{\frac{1}{2}}$. 

```{r}
vol_C_plot <- vol_C[2:101]

# vol_C_plot<-dropFirst(vol_C)
```

Interestingly, the filterd standard deviations are increasing at  a decreasing pace until converging to a limit value equal to `r round(vol_C_plot[7], 2)` after six iterations.

```{r, fig.width=6, fig.height=4, fig.cap="\\label{Fig:standard deviations} Standard deviations of states estimates"}

df_nile_sd <-data.frame(years_Nile, vol_C_plot)
   
 ggplot(df_nile_sd, aes(x=years_Nile))+
  geom_line(aes(y=vol_C_plot), color = "steelblue") +
  geom_vline(xintercept = as.Date('1899/01/01'), color= "black")+
  theme_classic(base_size=9) +
  theme(plot.title=element_text(hjust=0.5)) +
  labs(y="", x="Year") +
  scale_x_date(date_breaks="20 years",
               date_minor_breaks="10 year",
               limits=as.Date(c('1871_01_01','1970_01_01'),
                              tryFormats=c("%Y_%m_%d"),
                              optional=FALSE),
               labels=date_format("%Y")) +
  scale_y_continuous(breaks = seq(0,100,10), limits = c(0,100)) +
  theme(axis.text.x=element_text(hjust=1),
        plot.title=element_text(size=10, face="bold", margin=margin(0,0,10,0)),
        axis.title.x=element_text(family="Times", margin=margin(t=5)),
        axis.title.y=element_text(family="Times", margin=margin(r=5)))
```


Finally, we compute the $1 - \alpha$ Bayesian credible intervals for the filtering states estimates, which are given by:

\begin{align*}
[ m_t - Z_{1 - \frac{\alpha}{2}} \sqrt{C_{t}}, \quad m_t - Z_{1 - \frac{\alpha}{2}}\sqrt{C_{t}} ]
\end{align*}

with $\alpha = 0.05$. We report in Figure \ref{Filtering_est_ci} the filtering estimates with the credible intervals. 

```{r, fig.width=6, fig.height=4, fig.cap="\\label{Filtering_est_ci} Filtering estimates with credible intervals"}

upper <- filt_est + 1.96*vol_C_plot 
lower <- filt_est - 1.96*vol_C_plot 

df_nile_ci <-data.frame(years_Nile, Nile, filt_est, upper, lower)
   
 ggplot(df_nile_sd, aes(x=years_Nile))+
  geom_line(aes(y=Nile), color = "steelblue") +
  geom_line(aes(y=filt_est), color = "red") +
  geom_line(aes(y=upper), color = "red", linetype = "dashed" )+
  geom_line(aes(y=lower), color = "red", linetype = "dashed")+
  geom_vline(xintercept = as.Date('1899/01/01'), color= "black")+
  theme_classic(base_size=9) +
  theme(plot.title=element_text(hjust=0.5)) +
  labs(y="", x="Year") +
  scale_x_date(date_breaks="20 years",
               date_minor_breaks="10 year",
               limits=as.Date(c('1871_01_01','1970_01_01'),
                              tryFormats=c("%Y_%m_%d"),
                              optional=FALSE),
               labels=date_format("%Y")) +
  scale_y_continuous(breaks = seq(0,1500,300), limits = c(300,1500)) +
  theme(axis.text.x=element_text(hjust=1),
        plot.title=element_text(size=10, face="bold", margin=margin(0,0,10,0)),
        axis.title.x=element_text(family="Times", margin=margin(t=5)),
        axis.title.y=element_text(family="Times", margin=margin(r=5)))
```

\newpage
\section{Question 2}

We now plot in Figure \ref{Fig:Forecast with ci} along with the data the one-step ahead forecasts for the observation process (green line), i.e. $\hat{y}_{t}=\E{Y_{t} | y_{1:t-1}}=f_t$, where $f_t$ is the location parameter of the observation's forecast distribution. We plot also the credible interval at $1-\alpha$ level that are given by:

\begin{align*}
[ f_t - Z_{1 - \frac{\alpha}{2}} \sqrt{Q_{t}}, \quad f_t - Z_{1 - \frac{\alpha}{2}}\sqrt{Q_{t}} ]
\end{align*}

with $\alpha=0.05$.

The variances $Q_t's$ are just a byproduct of the procedure outlined in Question 1. Indeed, they are obtained as

\begin{align*}
Q_t = F_t \, R_t \, F_{t}'+ V_t = C_{t-1}+\sigma_{v}^2+\sigma_{w}^2
\end{align*}

with $F_t=1$.

```{r}
# Create the vector of means for the observation process.
# Notice that here we do not have to remove the first element of the series
mean_forecast<-filt_Nile$f

# Obtain the variance Q
filt_Q <- unlist(list_c) + as.vector(rw_Nile$V) + as.vector(rw_Nile$W)
filt_Q <- filt_Q[-1]

# Create upper and lower bounds of the credible interval
upper_for <- mean_forecast + 1.96*sqrt(filt_Q) 
lower_for <- mean_forecast - 1.96*sqrt(filt_Q) 
```

```{r, fig.width=6, fig.height=4, fig.cap="\\label{Fig:Forecast with ci} One-step ahead forecasts with credible intervals"}

df_nile_for <-data.frame(years_Nile, Nile, mean_forecast, upper_for, lower_for)
   
 ggplot(df_nile_for, aes(x=years_Nile))+
  geom_line(aes(y=Nile), color = "steelblue") +
  geom_line(aes(y=mean_forecast), color = "green") +
  geom_line(aes(y=upper_for), color = "green", linetype = "dashed" )+
  geom_line(aes(y=lower_for), color = "green", linetype = "dashed")+
  geom_vline(xintercept = as.Date('1899/01/01'), color= "black")+
  theme_classic(base_size=9) +
  theme(plot.title=element_text(hjust=0.5)) +
  labs(y="", x="Year") +
  scale_x_date(date_breaks="20 years",
               date_minor_breaks="10 year",
               limits=as.Date(c('1871_01_01','1970_01_01'),
                              tryFormats=c("%Y_%m_%d"),
                              optional=FALSE),
               labels=date_format("%Y")) +
  scale_y_continuous(breaks = seq(0,1500,300), limits = c(300,1500)) +
  theme(axis.text.x=element_text(hjust=1),
        plot.title=element_text(size=10, face="bold", margin=margin(0,0,10,0)),
        axis.title.x=element_text(family="Times", margin=margin(t=5)),
        axis.title.y=element_text(family="Times", margin=margin(r=5)))
```

\newpage
\section{Question 3}

The behavior of the process $(Y_t)$ is highly influenced by the ratio between the two error variances, $r = \frac{W}{V}$, which is called the *signal-to-noise ratio. For any given $C_0$, if it is small, $K_t$ is small and as a consequence $y_t$ receives little weight. On the contrary, if it is large, $y_t$ receives high weight abd the one-step-ahead forecast is close to the most recent data point.  