---
title: "20236 Time Series Analysis - Final project"
author:
- Simone Arrigoni (1794692)
- Luca Badolato (3086040)
- Simone Valle (3088281)
subtitle: "Bocconi University"
date: "21/4/2020"
output: pdf_document
nocite: '@*'
bibliography: References.bib
header-includes:
  \usepackage[utf8]{inputenc}
  \usepackage{setspace}
  \usepackage{parskip}
  \usepackage{apacite}
  \usepackage{natbib}
  \usepackage{algpseudocode}
  \usepackage{algorithm}
  \usepackage{bm}
  \usepackage{amsmath}
  \usepackage{amssymb}
  \usepackage{graphicx}
  \usepackage{subfig}
  \usepackage{booktabs, caption}
  \usepackage{array}
  \usepackage{threeparttable}
  \usepackage{listings}
  \usepackage{physics}
  \usepackage{float}
  \usepackage{appendix}
  \usepackage{nicefrac}
  \floatplacement{figure}{H}
  \usepackage{color} %red, green, blue, yellow, cyan, magenta, black, white
  \definecolor{mygreen}{RGB}{28,172,0} % color values Red, Green, Blue
  \definecolor{mylilas}{RGB}{170,55,241}
  \definecolor{codegray}{RGB}{0.5,0.5,0.5}
  \definecolor{orange}{RGB}{255,165,0}
  \DeclareMathOperator*{\E}{\mathbb{E}}
  \DeclareMathOperator*{\Ec}{\mathbb{E}_t}
  \setlength{\parindent}{0pt}
  \setlength\parskip{1.0pt}
  
---

```{r, include=FALSE}

# Load useful packages
library(utf8)
library(labeling)
library(rmarkdown)
library(httr)
library(knitr)
library(tseries)
library(tinytex)
library(scales)
library(dlm)
library(magrittr)
library(stringr)
library(depmixS4)
library(tidyverse)
library(ggthemes)
library(latex2exp)
library(kableExtra)
library(ggpubr)
library(reshape2)

# Settings
knitr::opts_chunk$set(message = FALSE, 
                      warning = FALSE,
                      echo    = FALSE,
                      include = TRUE,
                      fig.pos = "H",
                      fig.align = "center")
```

\abstract{INSERT ABSTRACT HERE}

\section{Introduction}

The dataset \texttt{US\_pollution} contains monthly and daily data about air pollution for each state in the United States. It is provided by the United States Environmental Protection Agency (EPA). Specifically, four key indicators of air pollution are considered: 

\begin{itemize}
\item \textbf{Ground level ozone $\text{O}_{3}$} (\texttt{O3}): Bad ozone forms near the ground when pollutants (emitted by sources such as cars, power plants, industrial boilers, refineries, and chemical plants) react chemically in sunlight. Since it is more likely to form during warmer months, we expect to see a seasonal component. 
\item \textbf{Nitrogen dioxide $\text{NO}_{2}$} (\texttt{NO2}): It is produced as a result of road traffic and other fossil fuel combustion processes. Furthermore, its presence in air contributes to the formation and modification of other air pollutants, such as particle pollution.
\item \textbf{Carbon monoxide $\text{CO}$} (\texttt{CO}):  It forms from incomplete combustions mainly from vehicle exhausts (roughly 75\% of all carbon monoxide emissions nationwide and up to 95\% in cities), fuel combustion in industrial processes and natural sources. Cold temperatures make combustion less complete, therefore we expect also in this case a seasonal behavior. 
\item \textbf{Sulfur dioxide $\text{SO}_{2}$} (\texttt{SO2}): It is produced when sulfur-containing fuels are burned. It is common mainly in large industrial complexes. 
\end{itemize}
\medskip

Hence, the four variables of interest are interconnected and are the building blocks of a more general phenomenon, that is air pollution. Furthermore, they are related by a common latent process that can be summarized by several components such as industrialization, car traffic and regulation. 

\section{Data}

The preliminary analysis that led us from the raw data to the current dataset is made available in the GitHub repository https://github.com/SimoneArrigoni/US_pollution. 

We will be focusing on measures for \textbf{Louisiana}, recorded weekly from 01/01/2000 to 27/04/2016, for a total of 852 observations. The main advantage of studying the evolution of air pollution in the same country over the years is that this allows us to control for fixed effects and to better study the latent process of interest that relates the four pollution components.The first five observations of the dataset are reported in Table \ref{tab:louisiana_df}.

```{r echo=FALSE}
# Import the dataset
louisiana_df <- read.csv(url("https://raw.githubusercontent.com/SimoneArrigoni/US_pollution/master//Louisiana_dataset.csv"), sep = ",", header=T)
```

```{r}
# How the dataset looks like
knitr::kable(louisiana_df[1:5, 1:5], "latex", booktabs=T,
             caption="Dataset structure\\label{tab:louisiana_df}") %>%
  kable_styling(latex_options="hold_position")
```
\bigskip

As explained in above, the four variables are related by a common latent process. Hence, we report in Table \ref{tab:louisiana_corr} their correlation coefficients.

```{r}
# Correlation plot
datacor = subset(louisiana_df, select=c(weekly_O3_mean, weekly_NO2_mean, weekly_CO_mean, weekly_SO2_mean))
cor.datacor = cor(datacor, use="complete.obs")
cormat = round(cor(datacor),2)
row.names(cormat) <- c("$\\text{O}_{3}$",
                       "$\\text{NO}_{2}$",
                       "$\\text{CO}$",
                       "$\\text{SO}_{2}$")

knitr::kable(cormat, "latex", booktabs=T, align="c", escape=F,
             caption="Correlation table \\label{tab:louisiana_corr}",
             col.names=c("$\\text{O}_{3}$",
                         "$\\text{NO}_{2}$",
                         "$\\text{CO}$",
                         "$\\text{SO}_{2}$")) %>%
  column_spec(1:4, width="5em") %>%
kable_styling(latex_options="hold_position")
```

Provided that the correlation between pollutants show significant differences in regional patterns and that $\text{CO}$ is a good indicator for industrial and biomass burning pollution [@Logan1981], a positive and strong correlation with $\text{O}_{3}$ indicates that a region has experienced photochemical $\text{O}_{3}$ production from its precursors (including $\text{CO}$) and is aligned with previous studies in the field [@Voulgarakis2011].

Other studies report that, in the US, $\text{O}_3$ is on average positively correlated with $\text{NO}_2$, which is opposite to our empirical findings about Louisiana, where they are slightly negatively correlated. A possible explanation can be given by substitution effects: an increase of nitrogen dioxide levels can be associated to the use of more fossil fuels that produce $\text{NO}_2$ instead of others. This might be related to Louisiana's fixed effects, however further rasearches would be beyond the purpose of our study.

We plot in Figure \ref{fig:louisiana_plots} the time series for the four pollutants under study to give a first qualitative description of the phenomenon.

```{r, fig.width=20, fig.height=6, fig.cap="\\label{fig:louisiana_plots} Air pollution in the state of Louisiana"}

# Time series plot
O3 <- ggplot(louisiana_df, aes(x=n_weeks, y=weekly_O3_mean)) +
  geom_line(color="steelblue") +
  theme_classic(base_size=9) +
  labs(y=expression(O[3]~(ppm)), x="Week") +
  scale_x_continuous(breaks=seq(0,900,100)) +
  theme(axis.text=element_text(size=13),
        axis.title.x=element_text(size=16,family="Times", margin=margin(t=5)),
        axis.title.y=element_text(size=16,family="Times", margin=margin(r=5)))

NO2 <- ggplot(louisiana_df, aes(x=n_weeks, y=weekly_NO2_mean)) +
  geom_line(color="steelblue") +
  theme_classic(base_size=9) +
  labs(y=expression(NO[2]~(ppb)), x="Week") +
  scale_x_continuous(breaks=seq(0,900,100)) +
  theme(axis.text=element_text(size=13),
        axis.title.x=element_text(size=16,family="Times", margin=margin(t=5)),
        axis.title.y=element_text(size=16, family="Times", margin=margin(r=5)))

CO <- ggplot(louisiana_df, aes(x=n_weeks, y=weekly_CO_mean)) +
  geom_line(color="steelblue") +
  theme_classic(base_size=9) +
  labs(y=expression(CO~(ppm)), x="Week") +
  scale_x_continuous(breaks=seq(0,900,100)) +
  theme(axis.text=element_text(size=13),
        axis.title.x=element_text(size=16,family="Times", margin=margin(t=5)),
        axis.title.y=element_text(size=16,family="Times", margin=margin(r=5)))

SO2 <- ggplot(louisiana_df, aes(x=n_weeks, y=weekly_SO2_mean)) +
  geom_line(color="steelblue") +
  theme_classic(base_size=9) +
  labs(y=expression(SO[2]~(ppb)), x="Week") +
  scale_x_continuous(breaks=seq(0,900,100)) +
  theme(axis.text=element_text(size=13),
        axis.title.x=element_text(size=16,family="Times", margin=margin(t=5)),
        axis.title.y=element_text(size=16,family="Times", margin=margin(r=5)))

ggarrange(O3, NO2, CO, SO2,
          ncol=2, nrow=2)
```

We restrict our attention to the \textbf{sulfur dioxide $\text{SO}_{2}$} data.

The time series does not look stationary and several change points characterize the plot. Indeed the mean of the series change over the years. Therefore, it is not possible to analyse it with the well-known ARMA models, which require stationarity. A suitable class of models for these cases is given by Hidden Markov Models.

\section{$\text{SO}_{2}$ series}
\subsection{Model specification}

Firstly, we model the series using a \textit{homogeneous} HMM, with a latent process $(S_{t})_{t\geq0}$ representing the industrialization activity or traffic level, as explained in the introduction.

Let's assume:
\begin{itemize}
\item three hidden states, that may be interpreted as high, medium and low comprehensive air pollution. Therefore, the state space of the latent process is $\mathcal{Y}=\{1,2,3\}$;
\item Gaussian emission distributions, with state-dependent mean $\mu_i$ and variance $\sigma_i$ with $i=1,2,3$.
\end{itemize}

\begin{align*}
\begin{cases}
Y_{t}=\mu_{1}+\varepsilon_{t}, \quad \varepsilon_{t}\overset{i.i.d.}{\sim}N(0,\sigma_{1}^2) \qquad \text{if} \; S_{t}=1 \\
Y_{t}=\mu_{2}+\varepsilon_{t}, \quad \varepsilon_{t}\overset{i.i.d.}{\sim}N(0,\sigma_{2}^2) \qquad \text{if} \; S_{t}=2 \\
Y_{t}=\mu_{3}+\varepsilon_{t}, \quad \varepsilon_{t}\overset{i.i.d.}{\sim}N(0,\sigma_{3}^2) \qquad \text{if} \; S_{t}=3
\end{cases}
\end{align*}

```{r}
# 1) Model specification
y <- as.numeric(louisiana_df$weekly_SO2_mean)
nstates_us <- 3
set.seed(61)
model_SO2 <- depmixS4::depmix(y ~ 1, data=data.frame(y), nstates=nstates_us)
```

\subsection{Estimation of the unknown parameters}

We estimate the unknown parameters by maximum likelihood, using an \textit{Expectation-Maximization (EM) algorithm}. In Table \ref{tab:HMM_MLE_SO2} we report the estimated means and standard deviations of the three states with the associated standard errors. 

```{r include=FALSE}
# 2) Estimation of the unknown parameters
fmodel_SO2 <- depmixS4::fit(model_SO2)
states_mu_sigma_SO2 <- depmixS4::summary(fmodel_SO2)
```
```{r}
# MLE
mu1hat_SO2 <- paste0(round(fmodel_SO2@response[[1]][[1]]@parameters$coefficients,3))
mu2hat_SO2 <- paste0(round(fmodel_SO2@response[[2]][[1]]@parameters$coefficients,3))
mu3hat_SO2 <- paste0(round(fmodel_SO2@response[[3]][[1]]@parameters$coefficients,3))
sd1hat_SO2 <- paste0(round(fmodel_SO2@response[[1]][[1]]@parameters$sd,3))
sd2hat_SO2 <- paste0(round(fmodel_SO2@response[[2]][[1]]@parameters$sd,3))
sd3hat_SO2 <- paste0(round(fmodel_SO2@response[[3]][[1]]@parameters$sd,3))
# se(MLE)
MLEse_SO2=depmixS4::standardError(fmodel_SO2)
se_mu1hat_SO2 <- paste0('(', round(MLEse_SO2$se[13],3), ')')
se_mu2hat_SO2 <- paste0('(', round(MLEse_SO2$se[15],3), ')')
se_mu3hat_SO2 <- paste0('(', round(MLEse_SO2$se[17],3), ')')
se_sd1hat_SO2 <- paste0('(', round(MLEse_SO2$se[14],3), ')')
se_sd2hat_SO2 <- paste0('(', round(MLEse_SO2$se[16],3), ')')
se_sd3hat_SO2 <- paste0('(', round(MLEse_SO2$se[18],3), ')')
```

```{r}
# Summary table creation
MLEsum_SO2 <- data.frame(state=c(rep("S=1",2), rep("S=2",2), rep("S=3",2)), 
                         mu=c(mu1hat_SO2, se_mu1hat_SO2, mu2hat_SO2, se_mu2hat_SO2, 
                              mu3hat_SO2, se_mu3hat_SO2),
                         sd=c(sd1hat_SO2, se_sd1hat_SO2, sd2hat_SO2, se_sd2hat_SO2,
                              sd3hat_SO2, se_sd3hat_SO2))
knitr::kable(MLEsum_SO2, "latex", booktabs=T, align="c",
             col.names = c("State", "$\\hat{\\mu}_{MLE}$", "$\\hat{\\sigma}_{MLE}$"),
             escape=F, caption="Maximum Likelihood estimates of the state-dependent
             mean and standard deviation\\label{tab:HMM_MLE_SO2}") %>%
  column_spec(1:3, width="5em") %>%
  collapse_rows(columns=1, latex_hline="none") %>%
  footnote(general="Standard errors in parentheses",
           general_title="Note:",
           footnote_as_chunk=T, escape=F) %>%
  kable_styling(latex_options="hold_position")
```

\subsection{Decoding}

Finally, we find the "optimal" state sequence associated with the observed $\text{SO}_{2}$ time series. The optimization problem is solved using the \textit{Viterbi algorithm} and the results are shown in Figure \ref{fig:model_fit_ost_SO2}.

```{r}
# Get the estimated state for each timestep 
estStates_SO2 <- posterior(fmodel_SO2)
```

```{r, fig.width=7, fig.height=3, out.width='60%', fig.cap="\\label{fig:model_fit_ost_SO2}Optimal state trajectory"}

# Plot the optimal path, that is stored in the first column of estStates
results_df_SO2 <- data.frame(time_index=louisiana_df$n_weeks,
                         SO2=louisiana_df$weekly_SO2_mean,
                         state=estStates_SO2[1]) %>% 
  gather("variable", "value", -time_index)

my_breaks <- function(x) { if (max(x)<4) seq(0,3,1) else seq(0,900,100) }
lab_names <- c(
  'SO2'="SO2 (ppb)",
  'state'="Viterbi state")

plotobj_SO2 <- ggplot(results_df_SO2, aes(time_index, value)) +
  geom_line(color="black") +
  facet_wrap(variable~., scales="free", ncol=1,
             strip.position="left",
             labeller = as_labeller(lab_names)) +
  labs(x="Week") +
  scale_y_continuous(breaks=my_breaks) +
  scale_x_continuous(breaks=seq(0,900,100))+
  theme_classic(base_size=9) +
  theme(axis.text=element_text(size=13),
        axis.title.x=element_text(size=16,family="Times", margin=margin(5,0,0,0)),
        axis.title.y=element_blank(),
        strip.text.x=element_text(size=16,family="Times", face="bold",
                                  margin=margin(10,0,0,0)),
        strip.background=element_rect(colour="black", fill=NA),
        strip.placement="outside")

plot(plotobj_SO2)
```

The series with HMM estimated state-dependent means and state-dependent standard deviations are shown in Figure \ref{fig:model_fit_rsm_SO2}.

```{r, fig.width=7, fig.height=3, fig.cap="\\label{fig:model_fit_rsm_SO2}State-dependent means and standard deviations"}

# Chart with state-dependent mean and standard deviations
info_df_SO2 <- data.frame(state=1:nstates_us,
                      mu_SO2=states_mu_sigma_SO2[,1],
                      sigma_SO2=states_mu_sigma_SO2[,2])
df_to_plot_SO2 <- estStates_SO2 %>%
  left_join(info_df_SO2)
df_to_plot_SO2 %<>%
  mutate(xtime=louisiana_df$n_weeks, yvalue=louisiana_df$weekly_SO2_mean)

ggplot(df_to_plot_SO2, aes(x=xtime, y=yvalue)) +
  geom_line(size=.2,aplha=.3) +
  geom_point(aes(x=xtime, y=mu_SO2), col="blue", size=.05) +
  geom_ribbon(aes(ymin=mu_SO2-2*sigma_SO2, ymax=mu_SO2+2*sigma_SO2), alpha=.1) +
  theme_classic(base_size=9) +
  theme(plot.title=element_text(hjust=0.5)) +
  labs(y=expression(SO[2]~(ppb)), x="Weeks") +
  scale_x_continuous(breaks=seq(0,900,100)) +
  theme(plot.title=element_text(size=10, face="bold", margin=margin(0,0,10,0)),
        axis.title.x=element_text(family="Times", margin=margin(t=5)),
        axis.title.y=element_text(family="Times", margin=margin(r=5)))
```

\newpage
\section{References}